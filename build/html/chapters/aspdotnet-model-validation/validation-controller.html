<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>15.4. Validating Models in a Controller &mdash; Textbook Template 2022 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="15.5. Validation and Views" href="validation-views.html" />
    <link rel="prev" title="15.3. Validation Attributes" href="validation-attributes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: purple" >
            <a href="../../index.html" class="icon icon-home"> Textbook Template
            <img src="../../_static/lc-ed-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction-and-setup/index.html">1. Introduction and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-types/index.html">2. Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../control-flow-and-collections/index.html">3. Control Flow and Collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../classes/index.html">4. Classes in C#, Part 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../classes-part2/index.html">5. Classes and Objects, Part 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unit-testing/index.html">6. Unit Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inheritance/index.html">7. Inheritance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interfaces-and-polymorphism/index.html">8. Interfaces and Polymorphism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aspdotnet-intro/index.html">9. Introduction to ASP.NET</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aspdotnet-controllers-and-routes/index.html">10. Controllers and Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exceptions/index.html">11. Rules to the Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vstools/index.html">12. Tools in Visual Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../razor-views/index.html">13. Razor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aspdotnet-model-classes/index.html">14. Models and Model Binding</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">15. ViewModels and Model Validation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="viewmodels.html">15.1. ViewModels and Passing Data To and From Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="server-side-validation.html">15.2. Server-Side Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="validation-attributes.html">15.3. Validation Attributes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">15.4. Validating Models in a Controller</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#validation-flow">15.4.1. Validation Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#handling-validation-errors-video">15.4.2. Handling Validation Errors - Video</a></li>
<li class="toctree-l3"><a class="reference internal" href="#handling-validation-errors-text">15.4.3. Handling Validation Errors - Text</a></li>
<li class="toctree-l3"><a class="reference internal" href="#check-your-understanding">15.4.4. Check Your Understanding</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="validation-views.html">15.5. Validation and Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercises.html">15.6. Exercises: ViewModels and Model Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="studio.html">15.7. Studio: Spa User Validation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../enums/index.html">16. Enumeration Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../orm-intro/index.html">17. Introduction to Object-Relational Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../orm-relationships/index.html">18. Relationships in Object-Relational Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auth/index.html">19. Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web-apis/index.html">20. Introduction to Web APIs &amp; REST</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/sql-install.html">Installing SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/vs-troubleshooting.html">Visual Studio Operational Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/postman-install.html">Installing Postman</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/exercise-solutions/index.html">Exercise Solutions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: purple" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Textbook Template</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">15. </span>ViewModels and Model Validation</a> &raquo;</li>
      <li><span class="section-number">15.4. </span>Validating Models in a Controller</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/chapters/aspdotnet-model-validation/validation-controller.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="validating-models-in-a-controller">
<span id="validating-models"></span><h1><span class="section-number">15.4. </span>Validating Models in a Controller<a class="headerlink" href="#validating-models-in-a-controller" title="Permalink to this headline"></a></h1>
<p>Validation involves both model and controller components of an MVC application.
After we have defined validation rules using attributes on the model, we must also update the controller to ensure that the rules are
checked and appropriate action is taken when validation fails.</p>
<div class="section" id="validation-flow">
<h2><span class="section-number">15.4.1. </span>Validation Flow<a class="headerlink" href="#validation-flow" title="Permalink to this headline"></a></h2>
<p>Before diving into the details of the code, let’s consider the logical flow of control for validating data in a request.
Let’s check out our <code class="docutils literal notranslate"><span class="pre">POST</span></code> action method for processing the <em>Add Event</em> form. Remember that this method uses model binding to create new <code class="docutils literal notranslate"><span class="pre">Event</span></code>
objects from form submissions.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="linenos">32</span><span class="na">[HttpPost]</span><span class="w"></span>
<span class="linenos">33</span><span class="k">public</span><span class="w"> </span><span class="n">IActionResult</span><span class="w"> </span><span class="nf">Add</span><span class="p">(</span><span class="n">AddEventViewModel</span><span class="w"> </span><span class="n">addEventViewModel</span><span class="p">)</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">   </span><span class="n">Event</span><span class="w"> </span><span class="n">newEvent</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Event</span><span class="w"></span>
<span class="linenos">36</span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="linenos">37</span><span class="w">      </span><span class="n">Name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addEventViewModel</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"></span>
<span class="linenos">38</span><span class="w">      </span><span class="n">Description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addEventViewModel</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span><span class="w"></span>
<span class="linenos">39</span><span class="w">      </span><span class="n">ContactEmail</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addEventViewModel</span><span class="p">.</span><span class="n">ContactEmail</span><span class="w"></span>
<span class="linenos">40</span><span class="w">   </span><span class="p">};</span><span class="w"></span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="w">   </span><span class="n">EventData</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">newEvent</span><span class="p">);</span><span class="w"></span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nf">Redirect</span><span class="p">(</span><span class="s">&quot;/Events&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">45</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The flow of this request can be described as follows:</p>
<ol class="arabic simple">
<li><p>Server receives <code class="docutils literal notranslate"><span class="pre">POST</span></code> request</p></li>
<li><p>Server creates <code class="docutils literal notranslate"><span class="pre">newEvent</span></code> object using request parameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Add()</span></code> is called with <code class="docutils literal notranslate"><span class="pre">newEvent</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">newEvent</span></code> is saved</p></li>
<li><p>A redirect response is returned, redirecting the user to <code class="docutils literal notranslate"><span class="pre">/Events</span></code></p></li>
</ol>
<p>The request creates an <code class="docutils literal notranslate"><span class="pre">Event</span></code> object using data from the incoming request.
Regardless of what the data looks like, the new object is saved to the data layer.
The user could submit an empty form, with no name or description filled in, and our code would be happy to create an <code class="docutils literal notranslate"><span class="pre">Event</span></code> and save it.
Similarly, a user could submit the full text of the massive novel “War and Peace” as the description.
This isn’t great.</p>
<div class="admonition-note admonition">
<p class="admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>Technically, submitting a request containing “War and Peace” would fail with most applications.
This is because web servers typically set a limit on the maximum size of a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request.
However, our application code is willing to take requests of any size, at this point.</p>
</div>
<p>Now that we have created <code class="docutils literal notranslate"><span class="pre">AddEventViewModel</span></code> and added validation attributes, we want to refactor our controller to use the ViewModel and handle errors in form submission.
Instead of using model binding to create a new <code class="docutils literal notranslate"><span class="pre">Event</span></code> object, we will use model binding to create a new <code class="docutils literal notranslate"><span class="pre">AddEventViewModel</span></code> object called <code class="docutils literal notranslate"><span class="pre">addEventViewModel</span></code>.
Our modest validation rules for a new <code class="docutils literal notranslate"><span class="pre">AddEventViewModel</span></code> object are as follows:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">Name</span></code> property must contain between 3 and 50 characters,</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Description</span></code> property may contain no more than 500 characters, and</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ContactEmail</span></code> property must satisfy email formatting rules.</p></li>
</ul>
<p>With these rules in place, conceptually, the flow of our controller code should look more like the following:</p>
<ol class="arabic simple">
<li><p>Server receives <code class="docutils literal notranslate"><span class="pre">POST</span></code> request</p></li>
<li><p>Server creates <code class="docutils literal notranslate"><span class="pre">addEventViewModel</span></code> object using request parameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Add()</span></code> (<code class="docutils literal notranslate"><span class="pre">POST</span></code> request type) is called with <code class="docutils literal notranslate"><span class="pre">addEventViewModel</span></code></p></li>
<li><p><strong>Controller checks for validation errors in the ViewModel object. If errors are found, return the user to the form. Otherwise, proceed.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">addEventViewModel</span></code> is used to create a new <code class="docutils literal notranslate"><span class="pre">Event</span></code> object called <code class="docutils literal notranslate"><span class="pre">newEvent</span></code>, which is saved to the data store.</p></li>
<li><p>A redirect response is returned, redirecting the user to <code class="docutils literal notranslate"><span class="pre">/Events</span></code></p></li>
</ol>
<p>Let’s look at how we can practically do this within ASP.NET Core MVC.</p>
</div>
<div class="section" id="handling-validation-errors-video">
<h2><span class="section-number">15.4.2. </span>Handling Validation Errors - Video<a class="headerlink" href="#handling-validation-errors-video" title="Permalink to this headline"></a></h2>

<div style="text-align:center;"><iframe width="800" height="450" src="https://www.youtube.com/embed/n1KMXzDzvuU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p></p>
<div class="admonition-note admonition">
<p class="admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>If you want to verify what code this video starts with, check out the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/validation-attributes" target="_blank">validation-attributes<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> branch.
If you want to verify what code this video ends with, check out the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/handling-errors" target="_blank">handling-errors<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> branch.</p>
<p>Actually, the first 4 minutes of the video above cover some of the code changes to get the project to the starting state of the <code class="docutils literal notranslate"><span class="pre">validation-attributes</span></code> branch.</p>
</div>
</div>
<div class="section" id="handling-validation-errors-text">
<h2><span class="section-number">15.4.3. </span>Handling Validation Errors - Text<a class="headerlink" href="#handling-validation-errors-text" title="Permalink to this headline"></a></h2>
<p>When using model binding, we can use tools to validate new model objects before they are saved to a data layer or database.</p>
<div class="section" id="using-modelstate-isvalid">
<h3><span class="section-number">15.4.3.1. </span>Using <code class="docutils literal notranslate"><span class="pre">ModelState.IsValid</span></code><a class="headerlink" href="#using-modelstate-isvalid" title="Permalink to this headline"></a></h3>
<p>Within <code class="docutils literal notranslate"><span class="pre">EventController</span></code>, the <code class="docutils literal notranslate"><span class="pre">Add()</span></code> action method uses model binding to receive an <code class="docutils literal notranslate"><span class="pre">AddEventViewModel</span></code> object when the form is posted.
That ViewModel instance is created using form data.
This object is NOT validated automatically, even if validation attributes are present on its fields.</p>
<p>Recall that <em>both</em> the model and controller play a role in validation.
The model’s responsibility is simply to define validation rules.
The controller must check that those rules are satisfied.</p>
<p><code class="docutils literal notranslate"><span class="pre">ModelState.IsValid</span></code> will check if the constraints on the model properties are met.
If these constraints are met, <code class="docutils literal notranslate"><span class="pre">ModelState.IsValid</span></code> equates to true and we want to create and add an <code class="docutils literal notranslate"><span class="pre">Event</span></code> object to our list of events.
If these constraints are not met and the ViewModel object is <em>not</em> valid, we want to redirect the user back to the <em>Add Event</em> form.</p>
<p>Once we are done refactoring the <code class="docutils literal notranslate"><span class="pre">Add()</span></code> action method to use <code class="docutils literal notranslate"><span class="pre">ModelState.IsValid</span></code>, our action method will look like the code below.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="linenos">32</span><span class="na">[HttpPost]</span><span class="w"></span>
<span class="linenos">33</span><span class="k">public</span><span class="w"> </span><span class="n">IActionResult</span><span class="w"> </span><span class="nf">Add</span><span class="p">(</span><span class="n">AddEventViewModel</span><span class="w"> </span><span class="n">addEventViewModel</span><span class="p">)</span><span class="w"></span>
<span class="linenos">34</span><span class="p">{</span><span class="w"></span>
<span class="linenos">35</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">36</span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="linenos">37</span><span class="w">      </span><span class="n">Event</span><span class="w"> </span><span class="n">newEvent</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Event</span><span class="w"></span>
<span class="linenos">38</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">39</span><span class="w">         </span><span class="n">Name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addEventViewModel</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"></span>
<span class="linenos">40</span><span class="w">         </span><span class="n">Description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addEventViewModel</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span><span class="w"></span>
<span class="linenos">41</span><span class="w">         </span><span class="n">ContactEmail</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">addEventViewModel</span><span class="p">.</span><span class="n">ContactEmail</span><span class="w"></span>
<span class="linenos">42</span><span class="w">      </span><span class="p">};</span><span class="w"></span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">      </span><span class="n">EventData</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">newEvent</span><span class="p">);</span><span class="w"></span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nf">Redirect</span><span class="p">(</span><span class="s">&quot;/Events&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">47</span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nf">View</span><span class="p">(</span><span class="n">addEventViewModel</span><span class="p">);</span><span class="w"></span>
<span class="linenos">50</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Now we have refactored our action method to handle any errors in form submission.
However, if you submit a value that doesn’t meet our conditions, you won’t see any error messages indicating what was wrong with your submission.
Let’s tackle that next!</p>
</div>
</div>
<div class="section" id="check-your-understanding">
<h2><span class="section-number">15.4.4. </span>Check Your Understanding<a class="headerlink" href="#check-your-understanding" title="Permalink to this headline"></a></h2>
<div class="admonition-question admonition">
<p class="admonition-title"><i class="fas fa-question" aria-hidden="true"></i>Question</p>
<p>Which of the following statements about <code class="docutils literal notranslate"><span class="pre">ModelState.IsValid</span></code> are true?</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ModelState.IsValid</span></code> can only be used in conjunction with model binding.</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">ModelState.IsValid</span></code> means that a method will never be called with invalid data.</p></li>
<li><p>ASP.NET can infer validation requirements based on the name of a field.</p></li>
</ol>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="validation-attributes.html" class="btn btn-neutral float-left" title="15.3. Validation Attributes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="validation-views.html" class="btn btn-neutral float-right" title="15.5. Validation and Views" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, LaunchCode.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>